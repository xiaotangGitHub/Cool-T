<?php
/**
 * Desc  ï¼šAnimate.php   ç³»ç»ŸèƒŒæ™¯ä¸»é¢˜
 * Author: Cool-T ğŸ˜€
 * Since : V1.0
 * Date  : 2018/10/30
 */

namespace app\admin\controller;


use think\facade\Request;
use app\admin\model\BgAnimate;

class Animate extends Base
{
    private $model;

    /**
     * åˆå§‹åŒ–
     */
    public function initialize()
    {
        parent::initialize(); // TODO: Change the autogenerated stub
        $this->model = new BgAnimate();
    }

    /**
     * åˆ—è¡¨
     * @return mixed
     * @throws \think\exception\DbException
     */
    public function index()
    {
        $list = BgAnimate::getList();
        $this->assign( 'list', $list );

        return $this->fetch();
    }

    /**
     * æ·»åŠ 
     * @return array|bool|mixed|\think\response\Json
     */
    public function add()
    {
        if( Request::isAjax() ){

            //éªŒè¯æ•°æ®
            $errMsg = $this->validateData( 'Animate', $_POST );
            if( $errMsg ) return $errMsg;

            $status = $this->model->save( $_POST );
            $this->endAction( $status, 'æ·»åŠ ç«™ç‚¹èƒŒæ™¯ä¸»é¢˜' );

        }else{
            return $this->fetch();
        }
    }

    /**
     * ä¿®æ”¹
     * @return array|bool|mixed|\think\response\Json
     */
    public function edit()
    {
        $id = input( 'id' );
        if( Request::isAjax() ){

            //éªŒè¯
            $errMsg = $this->validateData( 'Animate', $_POST );
            if( $errMsg ) return $errMsg;

            //ä¿®æ”¹
            $status = $this->model->save( $_POST, [ 'id' => $id ] );
            $this->endAction( $status, 'ä¿®æ”¹ç«™ç‚¹èƒŒæ™¯ä¸»é¢˜' );

        }else{
            $data = $this->model->get( $id );
            if( !$data ) abort( 404, 'å‚æ•°é”™è¯¯' );

            $this->assign( 'data', $data );
            return $this->fetch();
        }
    }

    /**
     * åˆ é™¤
     */
    public function del()
    {
        $id = input( 'id' );

        if( !Request::isAjax() || !$id ) abort( 404, 'é¡µé¢ä¸å­˜åœ¨' );

        $count = \app\admin\model\Admin::whereInCount( 'theme_id', $id );

        if( $count > 0 ){
            $this->endAction( false, false, 'è¦åˆ é™¤çš„ä¸»é¢˜ä¸‹æœ‰' . $count . 'ä¸ªç”¨æˆ·åœ¨ä½¿ç”¨ï¼Œæš‚æ— æ³•åˆ é™¤' );
        }

        //åˆ é™¤
        $status = BgAnimate::destroy( $id );
        $this->endAction( $status, 'åˆ é™¤ç«™ç‚¹èƒŒæ™¯ä¸»é¢˜' );
    }


    /**
     * çŠ¶æ€ä¿®æ”¹
     */
    public function setField()
    {
        if( !Request::isAjax() ) abort( 404, 'é¡µé¢ä¸å­˜åœ¨' );

        //æ¥æ”¶å‚æ•°
        $field = input('field' );
        $value = input( 'value' );
        $id = input( 'id' );

        //ä¿®æ”¹
        $status = BgAnimate::whereInSetField( 'id', $id, $field, $value );
        $this->endAction( $status, 'è®¾ç½®èƒŒæ™¯ä¸»é¢˜çŠ¶æ€' );
    }

}