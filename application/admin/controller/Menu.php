<?php
/**
 * Desc  ï¼šmenu.php  RBACèœå•æƒé™ç®¡ç†
 * Author: Cool-T ğŸ˜€
 * Since : V1.0
 * Date  : 2018/10/18
 */

namespace app\admin\controller;

use app\admin\model\AdminMenu;
use app\admin\model\BgAnimate;
use app\admin\model\RoleAdminMenu;
use think\Db;
use think\db\Where;
use think\facade\Request;


class Menu extends Base
{
    private $model;

    /**
     * åˆå§‹åŒ–
     */
    public function initialize()
    {
        parent::initialize(); // TODO: Change the autogenerated stub
        $this->model = new AdminMenu();
    }

    /**
     * åˆ—è¡¨
     * @return mixed
     * @throws \think\exception\DbException
     */
    public function index()
    {
        //whereæ¡ä»¶
        $where = new Where();
        $parent_id = input( 'id', 0 );
        $where['parent_id'] = $parent_id;
        if( isset( $_GET['name'] ) && $_GET['name'] ) $where['name'] = [ 'like', "%{$_GET['name']}%" ];
        if( isset( $_GET['path'] ) && $_GET['path'] ) $where['path'] = [ 'like', "%{$_GET['path']}%" ];

        //æŸ¥è¯¢èœå•
        $list = AdminMenu::getList( $where, [ 'sort' => 'asc', 'id' => 'asc' ] );
        $this->assign( [
            'list' => $list,
            'parent_id' => $parent_id
        ] );
        return $this->fetch();
    }

    /**
     * æ·»åŠ èœå•
     * @return mixed|\think\response\Json
     */
    public function add()
    {
        if( Request::isAjax() ){

            $_POST['path'] = $_POST['module'].'/'.$_POST['controller'].'/'.$_POST['action'];

            //éªŒè¯
            $errMsg = $this->validateData('Menu', $_POST );
            if( $errMsg ) return $errMsg;

            //æ·»åŠ 
            Db::startTrans();
            try{

                $this->model->allowField(true)->save( $_POST );

                $data = [
                    'role_id'   =>  $this->superAdminId,
                    'permission_id' =>  $this->model->id
                ];

                RoleAdminMenu::insert( $data );

                Db::commit();

                $this->endAction( true, 'æ·»åŠ èœå•' );

            }catch ( \Exception $e ){
                Db::rollback();
                $this->endAction( false, false, $e->getMessage() );
            }

        }else{
            //é¡¶çº§èœå•
            $menuSelect = AdminMenu::getSelect( [ 'parent_id' => 0 ], [ 'sort' => 'asc' ], 'id,name' );

            $this->assign( 'menuSelect', $menuSelect );
            return $this->fetch();
        }
    }

    /**
     * ç¼–è¾‘èœå•
     * @return array|bool|\think\response\View
     */
    public function edit()
    {
        if( Request::isAjax() ){

            $_POST['path'] = $_POST['module'].'/'.$_POST['controller'].'/'.$_POST['action'];

            //éªŒè¯
            $errMsg = $this->validateData('Menu', $_POST );
            if( $errMsg ) return $errMsg;

            //ä¿®æ”¹æ•°æ®
            $status = $this->model->allowField(true)->save( $_POST, [ 'id' => $_POST['id'] ] );
            $this->endAction( $status, 'ä¿®æ”¹èœå•' );

        }else{
            //å½“å‰æ“ä½œèœå•
            $id = input( 'id' );
            $data = $this->model->get( $id );
            if( !$data ) abort( 404, 'é¡µé¢ä¸å­˜åœ¨' );

            $data['path'] = explode( '/', $data['path'] );
            $this->assign( 'data', $data );

            //é¡¶çº§èœå•
            $menuSelect = AdminMenu::getSelect( [ 'parent_id' => 0 ], [ 'sort' => 'asc' ], 'id,name' );
            $this->assign( 'menuSelect', $menuSelect );

            //è·å–å­èœå•æ•°é‡
            $sonCount = AdminMenu::whereCount( [ 'parent_id' => $id ] );
            $this->assign( 'sonCount', $sonCount );

            return $this->fetch();
        }
    }

    /**
     * åˆ é™¤èœå•
     */
    public function del()
    {
        $id = input( 'id' );
        if( !Request::isAjax() || !$id ) return abort( 404, 'é¡µé¢ä¸å­˜åœ¨' );

        $sonCount = AdminMenu::whereCount( [ 'parent_id' => $id ] );
        if( $sonCount > 0 ) {
            $this->endAction( false, false, 'èœå•ä¸‹æœ‰' . $sonCount . 'ä¸ªå­èœå•ï¼Œè¯·åˆ é™¤å­èœå•åå†åˆ é™¤' );
        }

        Db::startTrans();
        try{
            AdminMenu::destroy( $id );
            RoleAdminMenu::where( [ 'permission_id' => $id ] )->delete();
            Db::commit();

            $this->endAction( true, 'åˆ é™¤èœå•' );

        }catch( \Exception $e ){
            Db::rollback();
            $this->endAction( false, false, $e->getMessage() );
        }
    }

    /**
     * è®¾ç½®æŒ‡å®šå­—æ®µå€¼
     */
    public function setField()
    {
        if( !Request::isAjax() ) abort( 404, 'é¡µé¢ä¸å­˜åœ¨' );

        //æ¥æ”¶æ•°æ®
        $id = input( 'id', '', 'trim' );
        $field = input( 'field', '', 'trim' );
        $value = input( 'value', '', 'trim' );

        switch ( $field ){
            //è®¾ç½®çŠ¶æ€
            case 'status':
                        $status = AdminMenu::whereInSetField( 'id', $id, 'status', $value );
                break;
            //è®¾ç½®é€‰ä¸­
            case 'checked':
                        $parent_id = input( 'parent_id' );
                        $path = AdminMenu::whereValue( [ 'id' => $id ], 'path' );
                        Db::startTrans();
                        try{
                            AdminMenu::whereSetField( 'id !='. $id . ' and parent_id ='. $parent_id, $field, 0 );
                            AdminMenu::whereSetField( 'id ='. $id . ' and parent_id ='. $parent_id, $field, 1 );
                            AdminMenu::whereSetField( [ 'id' => $parent_id ], 'path', $path );
                            Db::commit();
                            $status = true;
                        }catch ( \Exception $e ){
                            Db::rollback();
                            $status = false;
                        }
                break;
            //åŠ è½½åŠ¨ç”»
            case 'animate_status':
                        $status = BgAnimate::whereInSetField( 'id', $id, 'animate_status', $value );
                break;
        }

        if( isset( $status ) ) $this->endAction( $status, 'è®¾ç½®èœå•çŠ¶æ€' );
    }

}










