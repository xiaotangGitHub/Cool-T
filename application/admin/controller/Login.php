<?php
/**
 * Desc  ï¼šBase.php  åå°ç™»é™†é¡µ
 * Author: Cool-T ğŸ˜€
 * Since : V1.0
 * Date  : 2018/10/17
 */

namespace app\admin\controller;

use app\admin\model\AdminLogLogin;
use app\admin\model\AdminLogPass;
use app\admin\model\AdminMenu;
use app\common\model\SystemConfig;
use app\admin\model\Admin;
use app\api\controller\Captcha;
use app\api\controller\Token;
use think\Controller;
use think\Db;
use think\facade\Request;

class Login extends Controller
{
    /**
     * éªŒè¯æ˜¯å¦è·³è½¬
     */
    public function initialize()
    {
        parent::initialize(); // TODO: Change the autogenerated stub

        //éªŒè¯æ˜¯å¦æœ‰ç™»é™†
        $status = validateAdmin();
        $status = is_array( $status ) ? $status : json_decode( $status, true );
        if( $status['code'] == 200 && Request::action() != 'out' ){
            $loginJump = SystemConfig::whereValue( [ 'key' => 'login_jump' ], 'value' );
            if( $loginJump && getAdminInfo() ){
                $path = $this->getAdminIndexPath();
                $this->redirect( url( $path ) );
            }
        }

        //æ“ä½œæç¤ºéŸ³
        $msgAudio = SystemConfig::whereValue( [ 'key' => 'msgAudio' ], 'value' );
        $this->assign( 'msgAudioStatus', $msgAudio );

    }

    /**
     * ç™»é™†é¡µ
     * @return mixed
     * @throws \think\db\exception\DataNotFoundException
     * @throws \think\db\exception\ModelNotFoundException
     * @throws \think\exception\DbException
     */
    public function index()
    {
        //ç™»é™†éªŒè¯æç¤º
        $loginStatus = cookie( 'loginStatus' );
        cookie( 'loginStatus', null );
        $this->assign( 'codeErrorMsg', isset( $loginStatus['msg'] ) ? $loginStatus['msg'] : '' );

        //èƒŒæ™¯ç‰¹æ•ˆ
        $_filename = getAnimateFileName();

        $this->assign( '_filename', $_filename );

        $this->assign( '_title', 'ç³»ç»Ÿç™»é™†' );
        return $this->fetch();
    }

    /**
     * éªŒè¯ç™»é™†
     * @return \think\response\Json
     * @throws \think\db\exception\DataNotFoundException
     * @throws \think\db\exception\ModelNotFoundException
     * @throws \think\exception\DbException
     */
    public function logging()
    {
        if( !Request::isAjax() ) abort( '403', 'æ‹’ç»è®¿é—®' );

        $user = input( 'user', '', 'trim' );
        $pass = input( 'pass', '', 'trim' );
        $yzm  = input( 'yzm' , '', 'trim'  );
        $token = input( 'token', '', 'trim' );

        //éªŒè¯token
        $tokenObj = new Token();

        if( !$tokenObj->validate( $token ) ){
            return json( [ 'code' => 403, 'msg' => 'æ‹’ç»è®¿é—®ï¼' ] );
        }

        if( !$user ) return json( [ 'code' => 403, 'msg' => 'è¯·è¾“å…¥è´¦å·' ] );
        if( !$pass ) return json( [ 'code' => 403, 'msg' => 'è¯·è¾“å…¥å¯†ç ' ] );

        //éªŒè¯ç éªŒè¯
        $yzmObj = new Captcha();
        if( !$yzmObj->check( $yzm ) ){
            return json( [ 'code' => 403, 'msg' => 'éªŒè¯ç é”™è¯¯' ] );
        }

        //è·å–ç™»é™†æ•°æ®
        $admin = Admin::whereFind( [ 'user_name' => $user ] );

        //éªŒè¯
        if( !$admin ) return json( [ 'code' => 403, 'msg' => 'è´¦å·é”™è¯¯' ] );
        if( $admin['password'] != md5(  $pass ) ) return json( [ 'code' => 403, 'msg' => 'å¯†ç é”™è¯¯' ] );
        if( $admin['status']['value'] != 0 ) return json( [ 'code' => 403, 'msg' => 'ç¦æ­¢ç™»é™†ï¼Œè¯·è”ç³»è¶…çº§ç®¡ç†å‘˜' ] );
        if( $admin['time_bar']['value'] != 0 ){
            if( $admin['time_bar']['value'] < time() ) return json( [ 'code' => 403, 'msg' => 'è´¦å·å·²å¤±æ•ˆï¼Œè¯·è”ç³»è¶…çº§ç®¡ç†å‘˜' ] );
        }

        //sessionå­˜å…¥ 12å°æ—¶
        setAdminInfo( $admin, 43200 );

        if( !getAdminInfo() ) return json( [ 'code' => 403, 'msg' => 'ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•' ] );

        //ç™»é™†æ—¥å¿—
        $log = [
                'admin_id'  => $admin['id'],
                'user_name' => $admin['user_name'],
                'mobile'    => $admin['mobile'],
                'email'     => $admin['email'],
                'ip'        => ipChange( Request::ip() )
        ];
        AdminLogLogin::add( $log );
        //è·å–é¦–é¡µurl
        $path = $this->getAdminIndexPath();
        if( !$path ) return json( [ 'code' => 403, 'msg' => 'æ‚¨çš„è´¦å·æ— ç™»é™†æƒé™ï¼Œè¯·è”ç³»è¶…çº§ç®¡ç†å‘˜' ] );

        return json( [ 'code' => 200, 'msg' => 'ç™»é™†æˆåŠŸ', 'url' => url( $path ) ] );
    }


    /**
     * æ‰¾å›å¯†ç 
     * @return \think\response\Json
     * @throws \think\db\exception\DataNotFoundException
     * @throws \think\db\exception\ModelNotFoundException
     * @throws \think\exception\DbException
     */
    public function sendMail()
    {
        if( !Request::isAjax() ) abort( '403', 'æ‹’ç»è®¿é—®' );

        $user_name = input( 'user_name','', 'trim' );
        $email = input( 'email','', 'trim' );

        //éªŒè¯æ•°æ®
        $admin = Admin::whereFind( [ 'user_name' => $user_name ], 'email,id' );

        if( !$admin ) return json( [ 'code' => 403, 'msg' => 'è´¦å·ä¸å­˜åœ¨' ] );
        if( !trim( $admin['email'] ) ) return json( [ 'code' => 403, 'msg' => 'è¯¥è´¦å·æœªç»‘å®šé‚®ç®±ï¼Œè¯·è”ç³»è¶…çº§ç®¡ç†å‘˜ä¿®æ”¹' ] );
        if( $admin['email'] != $email ) return json( [ 'code' => 403, 'msg' => 'è¯·è¾“å…¥è¯¥è´¦å·ç»‘å®šçš„æ­£ç¡®é‚®ç®±ï¼' ] );

        //è¯·æ±‚é™åˆ¶
        $requestStatus = AdminLogPass::requestNum( $admin['id'] );
        if( !$requestStatus )   return json( [ 'code' => 403, 'msg' => 'æ‚¨çš„æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•' ] );

        //è®¾ç½®æ–°å¯†ç 
        $newPass = mt_rand( 100000, 999999 );
        $status = Db::name( 'admin' )->where( 'user_name', $user_name )->setField( 'password', md5( $newPass ) );

        if( $status ){

            //åˆ é™¤ç™»é™†ä¿¡æ¯
            delAdmin();

            //åˆå§‹åŒ–å¯†ç æ—¥å¿—å†™å…¥
            $log = [
                'admin_id'  =>  $admin['id'],
                'user_name' => $user_name,
                'new_pass'  => $newPass,
                'email'     => $email,
                'ip'        => ipChange( Request::ip() )
            ];
            AdminLogPass::add( $log );

            //é‚®ä»¶å‚æ•°
            $params = [
                'email'     =>  $email,
                'title'     =>  'å¯†ç æ‰¾å›',
                'content'   =>  'æ‚¨å¥½ï¼Œç³»ç»Ÿå·²å¸®æ‚¨åˆå§‹åŒ–å¯†ç ï¼Œæ‚¨çš„æ–°å¯†ç ä¸ºï¼š<span style="color: red;font-size: 30px;font-weight: bold">'. $newPass .'</span>ï¼Œè¯·å¦¥å–„ä¿å­˜ï¼ï¼ˆ å¦‚éœ€ä¿®æ”¹è¯·ç™»é™†åä¿®æ”¹ ï¼‰'
            ];
            //å‘é€é‚®ä»¶
            $resource = curlHttp( Request::domain().'/send_mail', http_build_query( $params ) );
            if( $resource['code'] == 200 ){
                return json( [ 'code' => 200, 'msg' => 'æ–°å¯†ç å·²å‘é€è‡³æ‚¨çš„é‚®ç®±ï¼Œè¯·æŸ¥æ”¶' ] );
            }else{
                return json( [ 'code' => 200, 'msg' => 'æ‚¨çš„æ–°å¯†ç ä¸ºï¼š'.$newPass ] );
            }
        }else{
            return json( [ 'code' => 403, 'msg' => 'ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•' ] );
        }
    }

    /**
     * è·å–åå°é¦–é¡µURL
     * @return mixed
     */
    private function getAdminIndexPath()
    {
        $adminUser = getAdminInfo();

        //è·å–å½“å‰ç®¡ç†å‘˜æ‰€æ‹¥æœ‰æƒé™çš„çˆ¶çº§ID
        $parent_id = AdminMenu::getParentId( $adminUser['id'] );

        //è·å–çˆ¶çº§èœå•å¯¹åº”çš„å­çº§èœå•è·¯å¾„
        $z_path = AdminMenu::getSonMenuPath( $parent_id, $adminUser['id'] );

        return $z_path;
    }

    /**
     * é€€å‡º
     */
    public function out()
    {
        delAdmin();
        if( getAdminInfo() ){
            $this->error( 'é€€å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•' );
        }else{
            $this->success( 'é€€å‡ºæˆåŠŸ', '/admin_login' );
        }
    }

}