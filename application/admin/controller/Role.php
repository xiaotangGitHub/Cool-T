<?php
/**
 * Desc  ï¼šRole.php  RBACè§’è‰²ç®¡ç†
 * Author: Cool-T ðŸ˜€
 * Since : V1.0
 * Date  : 2018/10/25
 */

namespace app\admin\controller;

use app\admin\model\AdminMenu;
use app\admin\model\AdminRole;
use app\admin\model\RoleAdmin;
use app\admin\model\RoleAdminMenu;
use think\Db;
use think\db\Where;
use think\facade\Request;

class Role extends Base
{
    private $model;

    public function initialize()
    {
        parent::initialize(); // TODO: Change the autogenerated stub
        $this->model = new RoleAdmin();
    }

    /**
     * æŸ¥çœ‹
     * @return \think\response\View
     * @throws \think\exception\DbException
     */
    public function index()
    {
        $where = new Where();
        $id = input( 'id' );
        if( $id ){
            $where['ar.role_id'] = $id;
            $where['a.id'] = [ 'neq', 1 ];
            $list = AdminRole::getRoleList( $where );
            $this->assign( 'id', $id );
        }else{
            if( isset( $_GET['name'] ) && $_GET['name'] ) $where['name'] = [ 'like', "%{$_GET['name']}%" ];
            $list = RoleAdmin::getList( $where, [ 'create_time' => 'asc' ] );
        }

        $this->assign('list', $list);
        return $this->fetch();
    }

    /**
     * æ·»åŠ 
     * @return array|bool|\think\response\View
     */
    public function add()
    {
        if( Request::isAjax() ){

            $errMsg = $this->validateData( 'RoleAdmin', $_POST );
            if( $errMsg ) return $errMsg;

            $status = $this->model->save( $_POST );
            $this->endAction( $status, 'æ·»åŠ ç®¡ç†å‘˜è§’è‰²' );

        }else{
            return $this->fetch();
        }
    }

    /**
     * ä¿®æ”¹
     * @return array|bool|\think\response\View
     */
    public function edit()
    {
        $id = input( 'id' );
        if( Request::isAjax() ){

            $errMsg = $this->validateData( 'RoleAdmin', $_POST );
            if( $errMsg ) return $errMsg;

            $status = $this->model->save( $_POST, [ 'id' => $id ] );
            $this->endAction( $status, 'ä¿®æ”¹ç®¡ç†å‘˜è§’è‰²' );

        }else{

            $data = RoleAdmin::whereFind( [ 'id' => $id ] );
            if( !$data ) abort( 404, 'é¡µé¢ä¸å­˜åœ¨' );

            $this->assign( 'data', $data );
            return $this->fetch();
        }
    }

    /**
     * ä¿®æ”¹æŒ‡å®šå­—æ®µå€¼
     */
    public function setField()
    {
        if( !Request::isAjax() ) abort( 404, 'é¡µé¢ä¸å­˜åœ¨' );

        $id = input( 'id' );
        $field = input( 'field' );
        $value = input( 'value' );

        $status = RoleAdmin::whereInSetField( 'id', $id, $field, $value );
        $this->endAction( $status, 'è®¾ç½®ç®¡ç†å‘˜è§’è‰²çŠ¶æ€' );
    }

    /**
     * åˆ é™¤
     */
    public function del()
    {
        $id = input( 'id' );
        if( !$id || !Request::isAjax() ) abort( 404, 'é¡µé¢ä¸å­˜åœ¨' );

        $count = AdminRole::whereInCount( 'role_id', $id );
        if( $count > 0 ){
            $this->endAction( false, false, 'è¦åˆ é™¤çš„è§’è‰²ä¸‹ç»‘å®šäº†'.$count.'ä½ç®¡ç†å‘˜ï¼Œè¯·è§£ç»‘åŽåˆ é™¤' );
        }

        $status = RoleAdmin::destroy( $id );
        $this->endAction( $status, 'åˆ é™¤ç®¡ç†å‘˜è§’è‰²' );
    }

    /**
     * è§’è‰²æƒé™è®¾ç½®
     * @return \think\response\View
     * @throws \Exception
     */
    public function permission()
    {
        if( Request::isAjax() ){
            //æŽ¥æ”¶å‚æ•°
            $id = input( 'id' );
            $data = input( 'data' );

            if( $data && count( $data ) > 0 ){
                //æœ‰å‹¾é€‰æƒé™
                Db::startTrans();
                try{
                    RoleAdminMenu::where( [ 'role_id' => $id ] )->delete();
                    RoleAdminMenu::insertAll( $data );
                    Db::commit();
                    $this->endAction( true, 'ç®¡ç†å‘˜è§’è‰²æƒé™è®¾ç½®' );
                }catch ( \Exception $e ){
                    Db::rollback();
                    $this->endAction( false, false, $e->getMessage() );
                }
            }else{
                //æœªå‹¾é€‰ä»»ä½•æƒé™
                $status = RoleAdminMenu::whereDel( [ 'role_id' => $id ] );
                $this->endAction( $status, 'ç®¡ç†å‘˜è§’è‰²æƒé™è®¾ç½®' );
            }

        }else{
            //èŽ·å–å·²é€‰ä¸­çš„èœå•æƒé™ID
            $id = input( 'id' );
            $permissionIds = RoleAdminMenu::whereColumn( [ 'role_id' => $id ], 'permission_id' );

            //èŽ·å–èœå•æƒé™
            $menus = AdminMenu::getMenuTree();

            $this->assign([
                'id'    => $id,
                'menus' => $menus,
                'permissionIds' => $permissionIds
            ]);
            return $this->fetch();
        }
    }
}