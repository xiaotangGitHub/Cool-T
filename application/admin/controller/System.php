<?php
/**
 * Desc  ï¼šsystem.php    ç³»ç»Ÿå…¨å±€é…ç½®
 * Author: Cool-T ğŸ˜€
 * Since : V1.0
 * Date  : 2018/10/24
 */

namespace app\admin\controller;


use app\common\model\SystemConfig;
use think\db\Where;
use think\facade\Request;

class System  extends Base
{
    private $model;

    /**
     * åˆå§‹åŒ–
     */
    public function initialize()
    {
        parent::initialize(); // TODO: Change the autogenerated stub
        $this->model = new SystemConfig();
    }

    /**
     * åˆ—è¡¨
     * @return mixed
     * @throws \think\exception\DbException
     */
    public function index()
    {
        //where
        $where = new Where();
        if( isset( $_GET['key'] ) && $_GET['key'] ) $where['key'] = [ 'like', "%{$_GET['key']}%" ];

        //æŸ¥è¯¢
        $list = SystemConfig::getList( $where, [ 'id' => 'desc' ] );

        $this->assign( 'list', $list );
        return $this->fetch();
    }

    /**
     * æ·»åŠ 
     * @return mixed|\think\response\Json
     */
    public function add()
    {
        if( Request::isAjax() ){

            if( isset( $_POST['imgs'] ) ){
                $_POST['value'] = implode(',',$_POST['imgs']);
            }

            //éªŒè¯
            $errMsg = $this->validateData( 'System', $_POST );
            if( $errMsg ) return $errMsg;

            //æ·»åŠ 
            $status = $this->model->save( $_POST );
            $this->endAction( $status, 'æ·»åŠ ç³»ç»Ÿå…¨å±€é…ç½®' );

        }else{
            return $this->fetch();
        }
    }

    /**
     * ä¿®æ”¹æ•°æ®
     * @return array|bool|mixed
     */
    public function edit()
    {
        $id  = input( 'id' );
        if( Request::isAjax() ){

            if( isset( $_POST['imgs'] ) ){
                $_POST['value'] = implode(',',$_POST['imgs']);
            }

            //éªŒè¯
            $errMsg = $this->validateData( 'System', $_POST );
            if( $errMsg ) return $errMsg;


            //ä¿®æ”¹æ•°æ®
            $status = $this->model->save( $_POST, [ 'id' => $id ] );
            $this->endAction( $status, 'ä¿®æ”¹ç³»ç»Ÿå…¨å±€é…ç½®' );

        }else{
            $data = $this->model->get( $id );
            if( !$data ) abort( 404, 'å‚æ•°é”™è¯¯' );

            $this->assign( 'data', $data );
            return $this->fetch();
        }
    }

    /**
     * åˆ é™¤æ•°æ®
     */
    public function del()
    {
        $id = input( 'id' );
        if( !Request::isAjax() || !$id ) abort( 404, 'é¡µé¢ä¸å­˜åœ¨' );

        $status = SystemConfig::destroy( $id );
        $this->endAction( $status, 'åˆ é™¤ç³»ç»Ÿå…¨å±€é…ç½®' );
    }

}