<?php
/**
 * Desc  ï¼šCommonAction.php  å…¬å…±æ“ä½œ ===> è·³å‡ºæƒé™éªŒè¯
 * Author: Cool-T ðŸ˜€
 * Since : V1.0
 * Date  : 2018/11/8
 */

namespace app\admin\controller;


use app\admin\model\Admin;
use app\admin\model\ImgsResource;
use app\admin\model\ImgsCategory;
use app\common\model\SystemConfig;
use Qiniu\Auth;
use Qiniu\Storage\UploadManager;
use think\Controller;
use think\Db;
use think\facade\Config;
use think\facade\Request;

class CommonAction extends Controller
{
    //ç®¡ç†å‘˜æ•°æ®
    private $adminUser;
    //ä¸Šä¼ ç›®å½•
    private $imgDir = 'uploads';

    /**
     * åˆå§‹åŒ–
     * @throws \think\db\exception\DataNotFoundException
     * @throws \think\db\exception\ModelNotFoundException
     * @throws \think\exception\DbException
     */
    public function initialize()
    {
        parent::initialize(); // TODO: Change the autogenerated stub
        $status = validateAdmin();
        $status = is_array( $status ) ? $status : json_decode( $status, true );
        if( $status[ 'code' ] != 200 ){
            cookie( 'loginStatus', $status );
            $this->redirect( '/admin_login' );
        }else{
            $adminUser = getAdminInfo();
            $this->adminUser = Admin::whereFind( [ 'id' => $adminUser['id'] ] );
        }
    }

    /**
     * ä¸Šä¼ å›¾ç‰‡
     * @return \think\response\Json
     * @throws \think\Exception
     * @throws \think\exception\PDOException
     */
    public function uploadImg()
    {
        //æŽ¥æ”¶å‚æ•°
        $file = Request::file( 'file' );
        if( !$file ) return json( [ 'code' => 403, 'msg' => 'è¯·ä¸Šä¼ å›¾ç‰‡' ] );
        $cid = input( 'cid', '', 'trim' );
        if( !$cid || $cid == 'undefined' ) return json( [ 'code' => 403, 'msg' => 'è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹' ] );

        //ä¸Šä¼ 
        $info = $file->move( $this->imgDir );
        if( $info ){
            $data = [
                'imgs_cid'  =>  $cid,
                'path'      =>  $this->imgDir.'/'.date('Ymd').'/',
                'img'       =>  $info->getFilename(),
                'name'      =>  $info->getInfo()['name'],
                'size'      =>  $info->getInfo()['size'],
                'ext'       =>  $info->getExtension(),
                'addtime'   =>  time(),
            ];

            $status = ImgsResource::insertGetId( $data );

            if( $status ){

                $qiNiuConfig = Config::get( 'qiNiuConfig.' );
                $auth = new Auth( $qiNiuConfig['accessKey'], $qiNiuConfig['secretKey'] );
                $token = $auth->uploadToken( $qiNiuConfig['bucket'], $data['img'] );

                $upManager = new UploadManager();

                list($ret, $error) = $upManager->putFile( $token, $data['img'], $info->getRealPath() );
                if( $error !== null ){
                    ImgsCategory::where( 'id', $status )->delete();
                    return json( [ 'code' => 403, 'msg' => 'ä¸ƒç‰›äº‘å­˜å‚¨å¤±è´¥' ] );
                }

                return json( [ 'code' => 200, 'msg' => 'æ·»åŠ æˆåŠŸ' ] );
            }else{
                return json( [ 'code' => 403, 'msg' => 'æ·»åŠ å¤±è´¥' ] );
            }

        }else{
            return json( [ 'code' => 403, 'msg' => $file->getError() ] );
        }
    }

    /**
     * æ–°å»ºå›¾ç‰‡åº“æ–‡ä»¶å¤¹åˆ†ç±»
     */
    public function addImgsCategory()
    {
        if( !Request::isAjax() ) abort( 404, 'é¡µé¢ä¸å­˜åœ¨' );
        $data = [
            'name'      => input( 'name', 'æœªå‘½åæ–‡ä»¶å¤¹', 'trim' ),
            'admin_id'  => $this->adminUser['id']
        ];

        $insertId = ImgsCategory::insertGetId( $data );
        if( $insertId ){
            return json( [ 'code' => 200, 'msg' => 'æ–°å»ºæˆåŠŸ', 'id' => $insertId ] );
        }else{
            return json( [ 'code' => 403, 'msg' => 'æ–°å»ºå¤±è´¥' ] );
        }
    }

    /**
     * ä¿®æ”¹å›¾ç‰‡åº“æ–‡ä»¶å¤¹åˆ†ç±»
     */
    public function editImgsCategory()
    {
        if( !Request::isAjax() ) abort( 404, 'é¡µé¢ä¸å­˜åœ¨' );
        $data = [
            'name'      => input( 'name', 'æœªå‘½åæ–‡ä»¶å¤¹', 'trim' ),
            'id'        => input( 'id' )
        ];
        $status = Db::name( 'imgs_category' )->update( $data );
        if( $status ){
            return json( [ 'code' => 200, 'msg' => 'ä¿®æ”¹æˆåŠŸ' ] );
        }else{
            return json( [ 'code' => 403, 'msg' => 'ä¿®æ”¹å¤±è´¥' ] );
        }
    }

    /**
     * åˆ é™¤å›¾ç‰‡åº“æ–‡ä»¶å¤¹åˆ†ç±»
     * @return \think\response\Json
     * @throws \think\Exception
     * @throws \think\exception\PDOException
     */
    public function delImgsCategory()
    {
        if( !Request::isAjax() ) abort( 404, 'é¡µé¢ä¸å­˜åœ¨' );
        $id = input( 'id' );
        $type = (int)input( 'type' );

        $status = ImgsCategory::where( [ 'id' => $id, 'admin_id' => $this->adminUser['id'] ] )->delete();
        if( $status ){

            if( $type == 1 ){
                //åŒæ—¶åˆ é™¤å›¾ç‰‡
                ImgsResource::whereSetField( [ 'imgs_cide' => $id ], 'del_status', 1 );
            }else{
                //ç§»åŠ¨æ–‡ä»¶å¤¹ä¸‹å›¾ç‰‡
                $moveId = ImgsCategory::whereValue( [ 'admin_id' => $this->adminUser['id'] ], 'id' );
                if( $moveId ){
                    ImgsResource::whereSetField( [ 'imgs_cid' => $id ], 'imgs_cid', $moveId );
                }else{
                    ImgsResource::whereSetField( [ 'imgs_cid' => $id ], 'del_status', 1 );
                }
            }

            return json( [ 'code' => 200, 'msg' => 'åˆ é™¤æˆåŠŸ' ] );

        }else{
            return json( [ 'code' => 403, 'msg' => 'åˆ é™¤å¤±è´¥' ] );
        }
    }

    /**
     * èŽ·å–å›¾ç‰‡
     * @return \think\response\Json
     * @throws \think\db\exception\DataNotFoundException
     * @throws \think\db\exception\ModelNotFoundException
     * @throws \think\exception\DbException
     */
    public function getImgsResource()
    {
        if ( !Request::isAjax() ) abort( 404, 'é¡µé¢ä¸å­˜åœ¨' );

        $page = input( 'page', 1, 'trim' );
        $num = input( 'num', 15, 'trim' );
        $cid = input( 'cid', '', 'trim' );
        $where =  [ 'imgs_cid' => $cid, 'del_status' => 0 ];
        $data = ImgsResource::getImgsPage( $where, $page, $num );
        $count = ImgsResource::whereCount( $where );

        $qiNiuStatus = SystemConfig::whereValue( [ 'key' => 'qiNiuStatus' ], 'value' );
        if( $qiNiuStatus ){
            $imgDomain = Config::get( 'qiNiuConfig.domain' );
        }else{
            $imgDomain = Request::domain().'/';
        }

        return json( [ 'data' => $data, 'count' => $count, 'domain' => $imgDomain, 'qi_niu_status' => $qiNiuStatus ] );
    }

    /**
     * ç§»åŠ¨å›¾ç‰‡
     * @return \think\response\Json
     */
    public function moveImgsResource()
    {
        if( !Request::isAjax() ) abort( 404, 'é¡µé¢ä¸å­˜åœ¨' );

        $ids = input( 'ids' );
        $cid = input( 'cid' );

        $status = ImgsResource::whereInSetField( 'id', $ids, 'imgs_cid', $cid );
        if( $status ){
            return json( [ 'code' => 200, 'msg' => 'ç§»åŠ¨æˆåŠŸ' ] );
        }else{
            return json( [ 'code' => 403, 'msg' => 'ç§»åŠ¨å¤±è´¥' ] );
        }
    }

    /**
     * åˆ é™¤å›¾ç‰‡
     * @return \think\response\Json
     */
    public function delImgsResource()
    {
        if( !Request::isAjax() ) abort( 404, 'é¡µé¢ä¸å­˜åœ¨' );

        $ids = input( 'ids' );

        $status = ImgsResource::whereInSetField( 'id', $ids, 'del_status', 1 );
        if( $status ){
            return json( [ 'code' => 200, 'msg' => 'åˆ é™¤æˆåŠŸ' ] );
        }else{
            return json( [ 'code' => 403, 'msg' => 'åˆ é™¤å¤±è´¥' ] );
        }
    }
}
















