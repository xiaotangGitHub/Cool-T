<?php
/**
 * Desc  ï¼šBase.php  åå°åŸºç±»
 * Author: Cool-T ğŸ˜€
 * Since : V1.0
 * Date  : 2018/10/17
 */

namespace app\admin\controller;

use app\admin\model\Admin;
use app\admin\model\AdminLogAction;
use app\admin\model\AdminMenu;
use app\admin\model\AdminRole;
use app\admin\model\BgAnimate;
use app\admin\model\ImgsCategory;
use app\common\model\SystemConfig;
use think\Controller;
use think\Db;
use think\facade\Request;

class Base  extends Controller
{
    //ä¸­é—´ä»¶
    protected $middleware = ['app\admin\middleware\ipAuth'];
    //åå°Title
    private $_title = 'åå°ç®¡ç†ç³»ç»Ÿ';
    //å½“å‰ç®¡ç†å‘˜ä¿¡æ¯
    protected $adminUser;
    //è¶…çº§ç®¡ç†å‘˜è§’è‰²ID
    protected $superAdminId = 1;

    /**
     * åˆå§‹åŒ–æ•°æ®
     * @throws \think\db\exception\DataNotFoundException
     * @throws \think\db\exception\ModelNotFoundException
     * @throws \think\exception\DbException
     */
    public function initialize()
    {
        parent::initialize(); // TODO: Change the autogenerated stub

        //éªŒè¯è´¦å·
        $this->validateAdmin();

        //æ˜¾ç¤ºèœå•
        $this->menu();

        //æ“ä½œæƒé™åˆ¤æ–­
        $this->checkPermissions();

        //å…¬å…±æ•°æ®
        $this->commonData();
    }

    /**
     * éªŒè¯ç™»é™†è´¦å·
     */
    private function validateAdmin()
    {
        $resource = validateAdmin();
        $resource = is_array( $resource ) ? $resource : json_decode( $resource, true );
        if( $resource[ 'code' ] != 200 ){
            cookie( 'loginStatus', $resource );
            $this->redirect( '/admin_login' );
        }else{
            $adminUser = getAdminInfo();
            $this->adminUser = Admin::whereFind( [ 'id' => $adminUser['id'] ] );
            $this->assign( 'adminUser', $this->adminUser );
            $this->assign( 'superAdminId', $this->superAdminId );
        }
    }

    /**
     * èœå•éå†è¾“å‡ºæ˜¾ç¤º
     * @return bool
     * @throws \think\db\exception\DataNotFoundException
     * @throws \think\db\exception\ModelNotFoundException
     * @throws \think\exception\DbException
     */
    private function menu()
    {
        //åªæœ‰getæ“ä½œæ˜¾ç¤ºèœå•
        if( !Request::isGet() ) return false;

        //è·å–é€‰ä¸­èœå•çš„ä¿¡æ¯
        $_path = Request::module() .'/'. Request::controller() .'/'. Request::action();

        $checkedMenu = AdminMenu::whereFind( "path = '{$_path}' and parent_id != 0", 'id,parent_id,animate_status,name,path' );

        if( !$checkedMenu ){
            $checkedMenu = AdminMenu::whereFind( "path = '{$_path}' and parent_id = 0", 'id,parent_id,animate_status,name' );

            $parentId = $checkedMenu['id'];
            $this->assign( 'subSeries', true );
        }else{
            $parentId = $checkedMenu['parent_id'];
        }

        //æ˜¯å¦åŠ¨æ€åŠ è½½è¯¥é¡µé¢( ä¸Šã€å·¦ã€å³ )
        $global_menu_animate = SystemConfig::whereValue( [ 'key' => 'global_menu_animate' ], 'value' );

        switch ( $global_menu_animate ){
            case '-1':
                $this->assign( 'animate_status', 0 );
                break;
            case '1':
                $this->assign( 'animate_status', 1 );
                break;
            default:
                $this->assign( 'animate_status', $checkedMenu['animate_status'] );
        }

        //çˆ¶èŠ‚ç‚¹èœå•
        $parentMenu = AdminMenu::getParentMenu( $this->adminUser['id'] );
        $this->assign( [
            'parentMenu'    =>  $parentMenu,
            'parentId'      =>  $parentId,
            '_path'          =>  strtolower( $_path )
        ] );

        //è·å–çˆ¶çº§èœå•å¯¹åº”çš„å­èœå•
        $leftMenu = AdminMenu::getSonMenu( $parentId, $this->adminUser['id'] );

        if( $leftMenu ) $leftMenu = arrayGroups( $leftMenu->toArray(), 'group_name' );

        //å·¦ä¾§å­èœå•åŠä¸»é¡µTitle
        $this->assign( [
            'leftMenu'  =>  $leftMenu,
            'menuTitle' => $checkedMenu['name']
        ] );
    }

    /**
     * æ“ä½œæƒé™åˆ¤æ–­
     */
    private function checkPermissions()
    {
        //åˆ¤æ–­æ˜¯å¦ä¸ºè¶…çº§ç®¡ç†å‘˜
        $superAdmin = AdminRole::whereValue( [ 'user_id' => $this->adminUser['id'], 'role_id' => $this->superAdminId ], 'id' );
        if( $superAdmin ) return false;

        //è·å–å½“å‰æ“ä½œ
        $path = Request::module() .'/'. Request::controller() .'/'. Request::action();

        //è·å–å½“å‰ç®¡ç†å‘˜è§’è‰²ID
        $roleId = AdminRole::whereValue( [ 'user_id' => $this->adminUser['id'] ], 'role_id' );

        //åˆ¤æ–­è¯¥é€‰ä¸­èœå•æ˜¯å¦æœ‰æ“ä½œæƒé™
        $status = AdminMenu::emptyMenu( $roleId, $path );

        if( !$status  ){

            //å¦‚æœæ˜¯ajaxè¯·æ±‚åˆ™ç›´æ¥è¿”å›æç¤ºä¿¡æ¯
            if( Request::isAjax() ) $this->error( 'æŠ±æ­‰ï¼Œæ‚¨æ²¡æœ‰æ“ä½œæƒé™' );

            //éªŒè¯çš„èœå•ç±»å‹  1ï¼šçˆ¶çº§èœå• 0ï¼šå­çº§èœå•
            $menu_parent_type = input( 'menu_parent_type', 0 );

            //å¦‚æœæ˜¯çˆ¶çº§
            if( $menu_parent_type == 1 ){

                //è·å–çˆ¶çº§èœå•ID
                $pid = AdminMenu::whereValue( [ 'path' => $path, 'parent_id' => [ 'neq', 0 ] ], 'parent_id' );

                //æ ¹æ®çˆ¶çº§èœå•è·å–æœ‰æƒé™çš„èœå•è·¯å¾„
                $path = AdminMenu::getSonMenuPath( $pid, $this->adminUser['id'] );

                if( $path ) $this->redirect( $path );

            }

            $this->error( 'æŠ±æ­‰ï¼Œæ‚¨æ²¡æœ‰è®¿é—®æƒé™' );

        }
    }

    /**
     * å…¬å…±æ•°æ®
     * @throws \think\db\exception\DataNotFoundException
     * @throws \think\db\exception\ModelNotFoundException
     * @throws \think\exception\DbException
     */
    private function commonData()
    {
        //ç«™ç‚¹åå°èƒŒæ™¯ä¸»é¢˜
        $_filename = BgAnimate::whereValue( [ 'id' => $this->adminUser['theme_id'] ], 'filename' );
        if( !$_filename ) $_filename = getAnimateFileName();

        //åå°æ“ä½œæç¤ºéŸ³
        $msgAudioStatus = SystemConfig::whereValue( [ 'key' => 'msgAudio' ], 'value' );

        //å›¾ç‰‡åº“åˆ†ç±»
        $where = [];
        if( $this->adminUser['id'] != 1 ){
            $where['admin_id'] = $this->adminUser['id'];
        }
        $imgsCategory = ImgsCategory::getSelect( $where, '', 'id,name' );

        //åº•éƒ¨ç‰ˆæƒè¯´æ˜
        $copyrightText = SystemConfig::whereValue( [ 'key' => 'admin_footer_text' ], 'value' );
        $copyrightUrl = SystemConfig::whereValue( [ 'key' => 'admin_footer_url' ], 'value' );

        //logo
        $logo = SystemConfig::whereValue( [ 'key' => 'admin_logo' ], 'value' );

        //åˆ—è¡¨æ— æ•°æ®æ—¶å±•ç¤º
        $listEmpty = '<td colspan="15" style="text-align: center">æš‚æ— æ•°æ®</td>';

        $this->assign([
            '_title'    =>  $this->_title,
            '_filename' =>  $_filename,
            'msgAudioStatus'    =>  $msgAudioStatus,
            'imgsCategory'  =>  $imgsCategory,
            'copyrightText'  =>  $copyrightText,
            'copyrightUrl'  =>  $copyrightUrl,
            'logo'  =>  $logo,
            '_empty'    =>  $listEmpty,
        ]);
    }

    /**
     * éªŒè¯æ•°æ®
     * @param string $className    éªŒè¯å™¨ç±»åç§°
     * @param array $data          æ•°æ®
     * @return array|bool
     */
    protected function validateData( $className, $data )
    {
        $namespaceClass = "\\app\\".Request::module()."\\validate\\".$className;
        $validate = new $namespaceClass();

        if( !$validate->check( $data ) ){
            $returnMsg = $validate->getError();

            //åˆ¤æ–­æ˜¯å¦æœ‰é€—å·',' ï¼Œè§„åˆ™ä¸ºæœ‰é€—å·ï¼Œåˆ™ é”™è¯¯æ¶ˆæ¯æŒ‡å‘inputæ¡†ï¼Œæœ‰ | ç¬¦å·åˆ™æŒ‡å‘é¡µé¢class
            if( strstr( $returnMsg, ',' ) ){
                $arr = explode( ',', $returnMsg );
                $returnMsg = [ 'code' => 403, 'msg' => $arr[0], 'element' => $arr[1], 'input' => true ];

                //åˆ¤æ–­æ˜¯å¦æœ‰'|'å·
            }elseif( strstr( $returnMsg, '|' ) ){
                $arr = explode( '|', $returnMsg );
                $returnMsg = [ 'code' => 403, 'msg' => $arr[0], 'element' => $arr[1] ];
            }

            return $returnMsg;

        }else{
            return false;
        }
    }

    /**
     * æ“ä½œç»“æŸåè®°å½•æ“ä½œæ—¥å¿—å¹¶å“åº”æ“ä½œçŠ¶æ€
     * @param $status
     * @param $actionDesc
     * @param null $actionMsg
     * @param null $url
     */
    protected function endAction( $status, $actionDesc, $actionMsg = null, $url = null )
    {
        //æ“ä½œæ—¥å¿—
        if( $status ){
            $path = Request::module() .'/'. Request::controller() .'/'. Request::action();
            $log = [
                'admin_id'  => $this->adminUser['id'],
                'user_name' => $this->adminUser['user_name'],
                'path'      => $path,
                'params'    => json_encode( input(), JSON_UNESCAPED_UNICODE ),
                'desc'      => $actionDesc
            ];
            AdminLogAction::add( $log );
        }

        //è¿”å›æ•°æ®
        $returnData = [
            'url'   =>  $url,
            'code'  =>  $status ? 200 : 403,
            'msg'   =>  $actionMsg ?: ( $status ? 'æ“ä½œæˆåŠŸ' : 'æ“ä½œå¤±è´¥' )
        ];

        exit( json_encode( $returnData ) );
    }
}